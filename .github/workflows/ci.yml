name: CI Pipeline

on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        php: ['8.0', '8.1']

    name: PHP ${{ matrix.php }} - Build & Test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: exif, fileinfo, zip, mbstring, pdo_mysql, sqlite3, bcmath, gd
          ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=2000M
          coverage: none

      - name: Copy environment file
        run: cp .env.workflow .env

      - name: Install Composer dependencies
        run: composer install --no-interaction --no-progress --prefer-dist --optimize-autoloader

      - name: Generate application key
        run: php artisan key:generate

      - name: Set up SQLite database
        run: |
          touch database/database.sqlite
          php artisan config:clear

      - name: Run database migrations
        run: php artisan migrate --force --seed

      - name: Seed demo data
        run: php artisan db:seed --class=DemoSeeder --force

      - name: Run Unit Tests
        run: php -d memory_limit=2000M vendor/bin/pest tests/Unit-Testing

      - name: Run Integration Tests
        run: php -d memory_limit=2000M vendor/bin/pest tests/Integration-Testing

      - name: Generate test coverage report for unit tests
        if: matrix.php == '8.1'
        run: php -d memory_limit=2000M vendor/bin/pest tests/Unit-Testing --coverage --min=50

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-php-${{ matrix.php }}
          path: |
            storage/logs/
            tests/results/